name: Release/Deployment  
on:
  push:
    tags:
      - 'v*'
  #workflow_run:
    #workflows:
      #- "PullRequest"
    #types:
      #- completed

jobs:
  # Set up necessary installs
  Build_SetUp_and_TDD:
    name: Build SetUp
    runs-on: ubuntu-latest
    services:
      mysql:
        image: koayyiting/mysql_test:latest
        ports:
          - 3306:3306
        env:
          MYSQL_ROOT_PASSWORD: can_we_still_score_for_dop
    steps:
    - name: Set Up Go
      uses: actions/setup-go@v5  # Setup Go after checkout
      with:
        go-version: '1.21.x'
        cache-dependency-path: subdir/go.sum

  wait_for_tag:
    name: Wait for Tag
    runs-on: ubuntu-latest
    steps:
      - name: Wait for Tag
        id: wait-for-tag
        run: echo "Waiting for a new tag to be created..."
        continue-on-error: true  # Allow the workflow to continue even if this step fails
        shell: bash
      - name: Set Tag
        id: set-tag
        run: echo "::set-output name=TAG_NAME::${GITHUB_REF#refs/tags/}"

  #Testing
    
  #Create Git Release
  Create_Git_Release:
    name: Create Git Release
    runs-on: ubuntu-latest
    steps:
      - name: Set environment version
        run: echo "RELEASE_VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
      - name: Create a release
        id: create-new-release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.RELEASE_VERSION }}
          release_name: Release ${{ env.RELEASE_VERSION }}
