#Release/Deployment 
name: Release/Deployment  
on:
  push:
    tags:
      - 'v*'
  #workflow_run:
    #workflows:
      #- "PullRequest"
    #types:
      #- completed

jobs:
  # Set up necessary installs
  Build_SetUp_and_TDD:
    name: Build SetUp
    runs-on: ubuntu-latest
    steps:
    - name: Set Up Go
      uses: actions/setup-go@v5  # Setup Go after checkout
      with:
        go-version: '1.21.x'
        cache-dependency-path: subdir/go.sum

  #Testing
    
  #Create Git Release
  Create_Git_Release:
    name: Create Git Release
    needs: Build_SetUp_and_TDD
    runs-on: ubuntu-latest
    steps:
    - name: Set environment version
      run: echo "RELEASE_VERSION=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV
    - name: create a release
      id: create-new-release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
      with:
        tag_name: ${{ env.RELEASE_VERSION }}
        release_name: Release ${{env.RELEASE_VERSION }}
          
    - name: Error Discord Notification
      if: ${{ failure() }}
      uses: rjstone/discord-webhook-notify@v1
      with:
          severity: error
          username: Mr CD
          avatarUrl: https://i.pinimg.com/originals/29/41/9a/29419ac1f185de6a80ce390e66e35f88.gif
          details: Create Git Release Fail
          webhookUrl: ${{ secrets.CD_DISCORD_WEBHOOK_URL }}


  Notify_Discord:
    runs-on: ubuntu-latest
    needs: Create_Git_Release
    steps:
      - name: Successful Discord Notification
        uses: rjstone/discord-webhook-notify@v1
        with:
            severity: info
            color: '#ff00aa'
            username: Mr CD
            avatarUrl: https://i.pinimg.com/originals/29/41/9a/29419ac1f185de6a80ce390e66e35f88.gif
            description: Success ${{ github.workflow }} Workflow from ${{ github.ref_name }}
            details: '(https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})'
            footer: By ${{ github.actor }}
            webhookUrl: ${{ secrets.CD_DISCORD_WEBHOOK_URL }}
          
